{% extends "base.html" %}
{% block title %}corrcloudwatch{% endblock %}
{% block content %}

<script language="javascript" type="text/javascript">
    // メトリクスを絞り込む
    function filter_metrics() {
        // フィルターテキストを取得
        var metrics_filter = $('input[name="metrics_filter"]')[0];
        var values = metrics_filter.value

        // メトリクスリストを取得
        var selectBox = $('select[name="list_metrics"]')[0];
        var items = selectBox.children;
        if (values == "") {
            for (var i = items.length - 1; i >= 0; i--) {
                items[i].style.display = "";
                // items[i].selected = false;
                set_message("メトリクスフィルターが選択されていません");
            }
            return;
        }

        var words = values.split(" ");
        var words = $.grep(words, function (e) {
            return e !== "";
        });
        for (var i = items.length - 1; i >= 0; i--) {
            items[i].style.display = "";
        }

        words.forEach(function (value) {
            var reg = new RegExp(".*" + value + ".*", "i");
            for (var i = items.length - 1; i >= 0; i--) {
                if (!items[i].textContent.match(reg)) {
                    items[i].style.display = "none";
                }
                items[i].selected = false;
            }
            selectBox.children[0].selected = true;
        });

        var result_count = 0;
        for (var i = items.length - 1; i >= 0; i--) {
            if (items[i].style.display == "") {
                result_count++
            }
        }


        set_message(`検索ワード:${words}, ヒット数:${result_count}`);
    }

    // 選択したメトリクスを下に追加する
    var add_metrics = function () {

        // 現在選択されているメトリクスの値を取得する
        var list_metrics = $('select[name="list_metrics"]');

        var metrics_val = list_metrics.val();
        var metrics_index = list_metrics.prop("selectedIndex");

        if (metrics_index == 0) {
            set_message("メトリクスが選択されていません");
            return;
        }

        // 既に選択されていた場合はアラート表示し、追加しない
        var selectedMetrics = 0
        $('input[name="target_metrics"]').each(function () {
            if ($(this).val() == metrics_val) {
                set_message("選択済みのメトリクスです");
                selectedMetrics++
            }
        });

        if (selectedMetrics == 1) {
            return;
        }

        // 現在の選択数
        var selected_count = $('input[name="target_metrics"]').length;

        // 相関出力の際のラベルとなるテキストを表示
        // ラベルの文字列を作成
        var edit = metrics_val;
        var metricName = edit.split(",")[1];
        if (edit.split(",").length > 2) {
            var Dimensions_name = edit.split(",")[2].split("=")[0];
            var Dimensions_value = edit.split(",")[2].split("=")[1];
            var labelstr = metricName + "_" + Dimensions_value;
        } else {
            var labelstr = metricName;
        }

        $('<input>', {
            id: `target_metrics_label_${selected_count}`,
            type: "text",
            name: "target_metrics_label",
            value: `${labelstr}`,
            class: "form-control metrics",
            html: `${labelstr}&nbsp;`,
        }).appendTo('div[name="target_metrics_group"]');

        // テキストボックスにて選択したメトリクスを表示
        $('<input>', {
            id: `target_metrics_${selected_count}`,
            type: "text",
            name: "target_metrics",
            value: `${metrics_val}`,
            class: "form-control metrics",
            html: `m${selected_count}&nbsp;`,
            readonly: "readonly",
        }).appendTo('div[name="target_metrics_group"]');

        // マイナスボタンを作成
        $('<button>', {
            id: `metricsminus_${selected_count}`,
            type: "button",
            value: `${metrics_val}`,
            class: "btn btn-default",
            onclick: "del_metrics(this);",
            html: "<i class='fa fa-minus' aria-hidden='true'></i> 削除",
        }).appendTo('div[name="target_metrics_group"]');
    }

    // メトリクス選択削除
    var del_metrics = function (value) {
        var index = value.id.split("_")[1];
        $(`#target_metrics_label_${index}`).remove();
        $(`#target_metrics_${index}`).remove();
        $(`#${value.id}`).remove();
    };

    // 相関分析実行
    var run_corr = function () {
        message = ""
        if ($('input[name="target_metrics"]').length < 3) {
            message += "3つ以上のメトリクスを選択してください<br>"
        };

        if ($('input[name="start_datetime"]').val() == "" || $('input[name="end_datetime"]').val() == "") {
            message += "開始日時と終了日時どちらとも指定してください"
        } else if ($('input[name="start_datetime"]').val() >= $('input[name="end_datetime"]').val()) {
            message += "終了日時には開始日時より後を指定してください"
        }

        if (message != "") {
            set_message(message, level = "warning");
            return false
        }
    };

    // 日付入力補助
    function set_date(start, end) {
        $('input[name="start_datetime"]').val(
            start.format('YYYY-MM-DD HH:mm')
        );
        $('input[name="end_datetime"]').val(
            end.format('YYYY-MM-DD HH:mm')
        );
    }

    function set_relative_date(period) {

        start = moment();
        end = moment();
        switch (period) {
            case "days":
                start = moment().add(-1, "days");
                break;
            case "week":
                start = moment().add(-1, "week");
                break;
            case "month":
                start = moment().add(-1, "month");
                break;
            case "years":
                start = moment().add(-1, "years");
                break;
            default:
                break;

        }

        set_date(start, end);
    }

    (function () {});
</script>

<form name="form-metrics" action="/" method="POST">
    <div class="form-group">
        <div class="row">
            <div class="col">
                <label class="col-form-label">間隔</label>
                <select class="form-control" name="period" required>
                    <option value="300">5分</option>
                    <option value="900">15分</option>
                    <option value="3600">1時間</option>
                    <option value="86400">1日</option>
                </select>
            </div>
            <div class="col">
                <label class="col-form-label">統計</label>
                <select class="form-control" name="statistics" required>
                    <option value="Average">平均</option>
                    <option value="Maximum">最大</option>
                    <option value="Minimum">最小</option>
                    <option value="Sum">合計</option>
                </select>
            </div>
        </div>
    </div>
    <div class="form-group row">
        <div class="col">
            <label class="col-form-label">開始日時</label>
            <input type="text" name="start_datetime" class="form-control" placeholder="YYYY-MM-DD HH:mm">
        </div>
        <div class="col">
            <label class="col-form-label">終了日時</label>
            <input type="text" name="end_datetime" class="form-control" placeholder="YYYY-MM-DD HH:mm">
        </div>
        <div class="col">
            <label class="col-form-label">相対値</label>
            <div>
                <button type="button" class="btn btn-outline-info" onclick="set_relative_date('days');">1日</button>
                <button type="button" class="btn btn-outline-info" onclick="set_relative_date('week');">1週間</button>
                <button type="button" class="btn btn-outline-info" onclick="set_relative_date('month');">1ヶ月</button>
                <button type="button" class="btn btn-outline-info" onclick="set_relative_date('years');">1年</button>
            </div>
        </div>
    </div>
    <div class="form-group" name="select-metrics">
        <div class="row">
            <div class="col-2">
                <label class="col-form-label" style="float:inline-end;">メトリクス</label>
            </div>
            <div class="col-6">
                <label class="col-form-label" style="color: gray">フィルターなしで{{ list_metrics_count }}件選択可能</label>
            </div>
        </div>
        <input class="form-control metrics" name="metrics_filter" placeholder="メトリクスフィルタ">
        <button type="button" class="btn btn-outline-info" onclick="filter_metrics();"><i class="fa fa-filter"
                aria-hidden="true"></i></button>
        <div class="form-group">
            <select class="form-control metrics" name="list_metrics" autofocus>
                <option>-----メトリクスを選択-----</option>
                {% for item in list_metrics %}
                { import os}
                {% if not item['Dimensions']  %}
                <option value="{{ item['Namespace'] }},{{ item['MetricName'] }}">
                    {{ item['Namespace'] }},{{ item['MetricName'] }}
                </option>
                {% endif %}
                {% for item_dim in item['Dimensions'] %}
                <option
                    value="{{ item['Namespace'] }},{{ item['MetricName'] }},{{ item_dim['Name'] }}={{ item_dim['Value'] }}">
                    {{ item['Namespace'] }},{{ item['MetricName'] }},{{ item_dim['Name'] }}={{ item_dim['Value'] }}
                </option>
                {% endfor %}
                {% endfor %}
            </select>
            <button type="button" class="btn btn-outline-info" onclick="add_metrics();"><i class="fa fa-plus"
                    aria-hidden="true"></i> 追加</button>
        </div>
    </div>
    <!-- 選択したメトリクスがここに列挙される -->
    <div class="card">
        <div class="card-header">選択済メトリクス</div>
        <div class="card-body" name="target_metrics_group">
        </div>
    </div>
    <div class="form-group">
        <button type="submit" class="btn btn-primary" onclick="return run_corr();">相関分析</button>
    </div>
</form>
{% endblock %}
